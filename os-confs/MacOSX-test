; 1st SECTION

N MacOSX-tests
M vecna <vecna@delirandom.net>
C ifconfig
C route
C arp
C arping
C iptables
C awk
C sed

; 2nd SECTION

; SPECIAL: ~T means: the tunnel interface name
; SPECIAL: ~Z means: the fake gateway ip address
; SPECIAL: ~K means: the fake mtu value
;         these value are specify by the users or hardcoded, therefore are treated differently

;1 get the default gateway ip address
I1 #route -n get default | grep gateway | sed -es/.*:\ //g#

;2 get the network interface used to reach the default gateway ($1)
I2 #route -n get default | grep interface | sed -es/.*:\ //g#

;3 get the ip address of $2 (the network interface at the point 2)
I3 #ifconfig ~2 | grep "inet " | sed -es/.*inet\ // | sed -es/\ netmask.*//#

;4 get the MTU of $2
I4 #ifconfig ~2 | grep " mtu " | sed -es/.*mtu\ //#

;5 get the mac address of $2
I5 #ifconfig ~2 | grep ether | sed -es/.*ether\ //#

;6 get the mac address of $1
I6 #arp -n 172.20.119.1 | sed -es/.*at\ // | sed -es/\ on.*//#

; 3rd SECTION

;7 add the janus-fake default gateway
S7 #route add default gw ~Z dev ~7#

;8 delete the janus-fake default gateway
S8 #route del default gw ~Z dev ~7#

;9 add a firewall rules able to drop incoming traffic with src mac addr $6
S9 #iptables -A FORWARD -i ~2 -m mac --mac-source ~6 -j DROP#

;A delete the firewall rules insert with $9
SA #iptables -D FORWARD -i ~2 -m mac --mac-source ~6 -j DROP#

;B setup the $6
SB #ifconfig ~6 ~2 pointopoint ~Z mtu ~K#

;C add a firewall rule able to NAT the traffic thru the tunnel $B
SC #iptables -A POSTROUTING -o ~6 -t nat -j MASQUERADE#

;D delete the firewall rule insert with $D
SD #iptables -D POSTROUTING -o ~6 -t nat -j MASQUERADE#

;E delete the system default gateway
SE #route del default#

;G restore the system default gateway
SG #route add default gw ~1#


